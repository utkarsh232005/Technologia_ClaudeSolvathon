<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anomaly Detection API Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #38bdf8;
        }

        h2 {
            color: #22d3ee;
            margin-top: 30px;
        }

        .test-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        button {
            background: linear-gradient(to right, #0891b2, #3b82f6);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 5px;
            transition: transform 0.2s;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-size: 12px;
            overflow-x: auto;
        }

        .success {
            border-left: 4px solid #22c55e;
        }

        .error {
            border-left: 4px solid #ef4444;
        }

        .loading {
            color: #fbbf24;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin: 2px;
        }

        .badge-success {
            background: #22c55e33;
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .badge-error {
            background: #ef444433;
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .badge-warning {
            background: #fbbf2433;
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stat-card {
            background: #334155;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #38bdf8;
        }

        .stat-label {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <h1>üî¨ Anomaly Detection API Test Suite</h1>
    <p>Test the anomaly detection endpoints from the browser</p>

    <!-- Test 1: Single Event Detection -->
    <div class="test-section">
        <h2>Test 1: Single Event Anomaly Detection</h2>
        <p>Detect anomalies in a single dark matter event</p>
        <button onclick="testSingleEvent(false)">Test WITHOUT Claude AI</button>
        <button onclick="testSingleEvent(true)">Test WITH Claude AI</button>
        <div id="single-result"></div>
    </div>

    <!-- Test 2: Batch Detection -->
    <div class="test-section">
        <h2>Test 2: Batch Event Detection</h2>
        <p>Detect anomalies in multiple events</p>
        <button onclick="testBatchDetection(false)">Test WITHOUT Claude AI</button>
        <button onclick="testBatchDetection(true)">Test WITH Claude AI</button>
        <div id="batch-result"></div>
    </div>

    <!-- Test 3: Dataset Analysis -->
    <div class="test-section">
        <h2>Test 3: Full Dataset Analysis</h2>
        <p>Analyze the entire dataset for anomalies</p>
        <button onclick="testDatasetAnalysis(false)">Test WITHOUT Claude AI</button>
        <button onclick="testDatasetAnalysis(true)">Test WITH Claude AI</button>
        <div id="dataset-result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001';

        function showLoading(elementId) {
            const el = document.getElementById(elementId);
            el.innerHTML = '<div class="result loading">‚è≥ Loading...</div>';
        }

        function showResult(elementId, data, isSuccess) {
            const el = document.getElementById(elementId);
            const className = isSuccess ? 'success' : 'error';
            const badge = isSuccess ?
                '<span class="badge badge-success">‚úì SUCCESS</span>' :
                '<span class="badge badge-error">‚úó FAILED</span>';

            el.innerHTML = `
                <div class="result ${className}">
                    ${badge}
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }

        async function testSingleEvent(useClaude) {
            showLoading('single-result');

            const event = {
                events: [{
                    energy: 150.5,
                    s1: 250,
                    s2: 8000,
                    s2s1Ratio: 32.0
                }],
                use_claude: useClaude,
                threshold: 0.3
            };

            try {
                const response = await fetch(`${API_BASE}/api/anomaly/detect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(event)
                });

                const data = await response.json();

                if (data.success) {
                    const result = {
                        success: true,
                        usedClaude: useClaude,
                        anomaliesDetected: data.anomalies_detected,
                        totalAnalyzed: data.total_events_analyzed,
                        anomalyRate: `${(data.anomaly_rate * 100).toFixed(1)}%`,
                        firstResult: data.results[0] ? {
                            isAnomaly: data.results[0].is_anomaly,
                            anomalyScore: data.results[0].anomaly_score.toFixed(3),
                            classification: data.results[0].classification,
                            confidence: `${(data.results[0].confidence * 100).toFixed(0)}%`,
                            flagsCount: data.results[0].anomaly_flags.length,
                            reasoning: data.results[0].reasoning.substring(0, 200) + (data.results[0].reasoning.length > 200 ? '...' : '')
                        } : null
                    };
                    showResult('single-result', result, true);
                } else {
                    showResult('single-result', data, false);
                }
            } catch (error) {
                showResult('single-result', { error: error.message }, false);
            }
        }

        async function testBatchDetection(useClaude) {
            showLoading('batch-result');

            const events = {
                events: [
                    { energy: 50, s1: 100, s2: 500, s2s1Ratio: 5.0 },
                    { energy: 200, s1: 300, s2: 10000, s2s1Ratio: 33.3 },
                    { energy: 30, s1: 80, s2: 400, s2s1Ratio: 5.0 },
                    { energy: 100, s1: 200, s2: 1000, s2s1Ratio: 5.0 }
                ],
                use_claude: useClaude,
                threshold: 0.3
            };

            try {
                const response = await fetch(`${API_BASE}/api/anomaly/detect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(events)
                });

                const data = await response.json();

                if (data.success) {
                    const result = {
                        success: true,
                        usedClaude: useClaude,
                        anomaliesDetected: data.anomalies_detected,
                        totalAnalyzed: data.total_events_analyzed,
                        anomalyRate: `${(data.anomaly_rate * 100).toFixed(1)}%`,
                        detectedAnomalies: data.results.map(r => ({
                            eventIndex: r.event_index,
                            score: r.anomaly_score.toFixed(3),
                            classification: r.classification,
                            flags: r.anomaly_flags.length
                        }))
                    };
                    showResult('batch-result', result, true);
                } else {
                    showResult('batch-result', data, false);
                }
            } catch (error) {
                showResult('batch-result', { error: error.message }, false);
            }
        }

        async function testDatasetAnalysis(useClaude) {
            showLoading('dataset-result');

            const params = {
                max_events: 50,
                use_claude: useClaude,
                threshold: 0.3
            };

            try {
                const response = await fetch(`${API_BASE}/api/anomaly/analyze-dataset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });

                const data = await response.json();

                if (data.success) {
                    const el = document.getElementById('dataset-result');
                    el.innerHTML = `
                        <div class="result success">
                            <span class="badge badge-success">‚úì SUCCESS</span>
                            <div class="stats">
                                <div class="stat-card">
                                    <div class="stat-value">${data.statistics.total_analyzed}</div>
                                    <div class="stat-label">Events Analyzed</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${data.statistics.anomalies_detected}</div>
                                    <div class="stat-label">Anomalies Found</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${(data.statistics.anomaly_rate * 100).toFixed(1)}%</div>
                                    <div class="stat-label">Anomaly Rate</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${data.statistics.avg_anomaly_score.toFixed(3)}</div>
                                    <div class="stat-label">Avg Score</div>
                                </div>
                            </div>
                            <h3 style="color: #22d3ee; margin-top: 20px;">Top 5 Anomalies:</h3>
                            ${data.top_anomalies.slice(0, 5).map((a, i) => `
                                <div style="background: #0f172a; padding: 10px; margin: 10px 0; border-radius: 6px;">
                                    <strong>#${i + 1} - Event ${a.event_index}</strong>
                                    <span class="badge ${a.severity === 'Critical' ? 'badge-error' : a.severity === 'High' ? 'badge-warning' : 'badge-success'}">${a.severity}</span>
                                    <br>
                                    Score: ${a.anomaly_score.toFixed(3)} | Classification: ${a.classification} | 
                                    Energy: ${a.energy.toFixed(2)} keV | S2/S1: ${a.s2s1_ratio.toFixed(2)}
                                    ${a.reasoning ? '<br><em style="color: #94a3b8;">' + a.reasoning.substring(0, 150) + '...</em>' : ''}
                                </div>
                            `).join('')}
                            <details style="margin-top: 20px;">
                                <summary style="cursor: pointer; color: #38bdf8;">Show Full Response JSON</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    showResult('dataset-result', data, false);
                }
            } catch (error) {
                showResult('dataset-result', { error: error.message }, false);
            }
        }
    </script>
</body>

</html>